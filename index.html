<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NequiBotGV - Comprobantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --color-morado:#3C114B;
      --color-orquidea:#DA0081; /* fucsia */
      --rosa-input:#F9ECF7;
      --rosa-boton:#F38DC1;
      --blanco:#fff;
      --baseW:390; /* ancho base del arte del comprobante */
      --escala:1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;padding:0;font-family:'Manrope',sans-serif;color:#200020;
      overscroll-behavior:none;background:#fff;
      overflow-x:hidden;
    }

    .bottom-mask{
      position:fixed;left:0;right:0;bottom:0;
      height:max(8px, env(safe-area-inset-bottom));
      background:#fff;z-index:9999;pointer-events:none;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px 8px 16px;
    }
    .icon{
      width:22px;height:22px;display:inline-block;color:#2a0b33;
      user-select:none;-webkit-user-drag:none
    }
    .page{
      max-width:420px;margin:0 auto;padding:0 16px 90px;
    }
    h1{margin:6px 0 10px;font-size:28px;font-weight:800;color:#2a0b33}

    .field{
      background:var(--rosa-input);
      border-radius:14px;padding:16px 14px;margin:14px 0;
      position:relative;display:flex;align-items:center;gap:10px;
      box-shadow:0 2px 0 rgba(0,0,0,.02) inset;
    }
    .field input{
      flex:1;border:none;background:transparent;outline:none;
      font-size:16px;color:#200020;
    }
    .hint{font-size:13px;color:#8a8291;margin-top:2px}
    .section-title{
      margin-top:14px;margin-bottom:10px;font-weight:800;color:#DA0081
    }

    .card{
      display:flex;align-items:center;justify-content:space-between;
      background:#fff;border-radius:14px;padding:14px 16px;margin:8px 0 22px;
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }
    .card-left{display:flex;align-items:center;gap:12px}
    .tile{
      width:34px;height:34px;border-radius:8px;background:#E93A98;
      display:grid;place-items:center;box-shadow:0 6px 12px rgba(233,58,152,.35);
    }
    .tile::before{
      content:"";width:18px;height:18px;border-radius:4px;background:#fff;box-shadow:10px 0 0 #fff, 0 10px 0 #fff, 10px 10px 0 #fff;
      transform:translate(-4px,-4px);
    }
    .arrow{width:18px;height:18px;border-right:2px solid #2a0b33;border-top:2px solid #2a0b33;transform:rotate(45deg)}

    .footer{
      position:fixed;left:0;right:0;bottom:0;background:transparent;
      padding:12px 16px calc(12px + env(safe-area-inset-bottom));z-index:900;
    }
    .footer .box{
      max-width:420px;margin:0 auto;background:#fff;border-radius:18px;
      box-shadow:0 -8px 26px rgba(0,0,0,.12);padding:12px;
    }
    .actions{display:flex;gap:12px}
    .btn{
      flex:1;border:none;border-radius:12px;padding:14px 10px;cursor:pointer;
      font-weight:800;color:#fff;
      background:linear-gradient(90deg,#DA0081,#f50057);
      box-shadow:0 6px 14px rgba(218,0,129,.32);
      font-size:16px;
    }

    /* ---------- VISOR del comprobante BLOQUEADO ---------- */
    .comprobante{
      display:none;position:fixed;inset:0;
      background:#000;
      z-index:1000;overflow:hidden;
      touch-action:none;
    }
    .stage{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%) scale(var(--escala));
      transform-origin:center center;
      width:calc(var(--baseW) * 1px);
    }
    .bg{
      display:block;width:calc(var(--baseW) * 1px);height:auto;
      user-select:none;-webkit-user-drag:none;pointer-events:none;
    }
    .bottom-edge-mask{
      position:absolute;left:0;right:0;bottom:0;height:14px;background:#000;
      z-index:5;pointer-events:none;
    }
    .input-overlay{
      position:absolute;background:transparent;border:none;
      font-size:14px;font-weight:500;color:var(--color-morado);
      font-family:'Manrope',sans-serif;pointer-events:none;z-index:10;
      white-space:nowrap;
    }
    /* Posiciones base */
    #nombre1{ top:367px; left:30px; right:20px; width:auto; white-space:normal; line-height:1.2em; }
    #valor1{  top:425px; left:30px }
    #nequi1{  top:484px; left:30px }
    #fecha1{  top:540px; left:30px }
    #referencia1{ top:600px; left:30px }
    #disponible1{ top:658px; left:30px; font-size:14px }
    #nombre2{ top:227px; left:61px; width:340px; font-size:12px; font-weight:500; text-transform:uppercase }
    #valor2{  top:236px; right:27px; width:280px; font-weight:900; font-size:13px; text-align:right; color:#b11b4a }

    /* ---------- Loader inicial (procesando) ---------- */
    .loader-overlay{
      position:fixed;inset:0;background:#fff;display:none;
      align-items:center;justify-content:center;z-index:1200;
    }
    .diamantes{position:relative;width:96px;height:42px}
    .diamante{
      position:absolute;top:50%;width:28px;height:28px;background:var(--color-orquidea);
      transform:translateY(-50%) rotate(45deg) scale(1);
      border-radius:4px;filter:drop-shadow(0 6px 10px rgba(218,0,129,.35));
      animation:pulse 1.1s infinite ease-in-out;
    }
    .diamante.left { left: calc(50% - 28px); transform:translate(-14px,-50%) rotate(45deg) scale(1); }
    .diamante.right{ left: 50%;            transform:translate(14px,-50%)  rotate(45deg) scale(1); animation-delay:.55s; }
    @keyframes pulse{
      0%{transform:translate(var(--tx,0),-50%) rotate(45deg) scale(.86);opacity:.85}
      50%{transform:translate(var(--tx,0),-50%) rotate(45deg) scale(1.14);opacity:1}
      100%{transform:translate(var(--tx,0),-50%) rotate(45deg) scale(.86);opacity:.85}
    }

    /* ---------- FINISH overlay: diamantes + botón ---------- */
    .finish-overlay{
      position:fixed;inset:0;background:#000;display:none;
      align-items:center;justify-content:center;flex-direction:column;
      gap:24px;z-index:1300;text-align:center;padding:24px;
    }
    .finish-title{color:#fff;font-weight:800;font-size:18px}
    .btn-finish{
      border:none;border-radius:12px;padding:14px 16px;cursor:pointer;
      font-weight:800;font-size:16px;color:#000;background:#fff;
      box-shadow:0 6px 16px rgba(255,255,255,.15);
      min-width:260px;
    }
    .btn-finish:active{transform:scale(.98)}
  </style>
</head>
<body>
  <div class="bottom-mask"></div>

  <!-- Header -->
  <div class="topbar">
    <span class="icon" aria-hidden="true">
      <!-- flecha back -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </span>
    <span class="icon" aria-hidden="true">
      <!-- check -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
    </span>
  </div>

  <div class="page" id="formulario">
    <h1>Envía plata</h1>

    <!-- Cel -->
    <div class="field">
      <input type="text" id="input-nequi" placeholder="Cel" inputmode="numeric" autocomplete="tel" />
      <!-- icono contacto -->
      <span class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="#2a0b33" stroke-width="2">
          <circle cx="12" cy="8" r="4"/><path d="M6 20c0-3.314 2.686-6 6-6s6 2.686 6 6"/>
        </svg>
      </span>
    </div>
    <div class="hint">Revisa bien el número para enviarle a la persona correcta</div>

    <!-- Valor -->
    <div class="field">
      <input type="text" id="input-valor" placeholder="¿Cuánto?" />
    </div>

    <!-- Mensaje -->
    <div class="field">
      <input type="text" id="input-nombre" placeholder="Mensaje" />
    </div>

    <div class="section-title">Escoge de donde saldrá la plata</div>
    <div class="card">
      <div class="card-left">
        <div class="tile"></div>
        <div style="font-weight:700">Disponible</div>
      </div>
      <div class="arrow" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Comprobantes: VISOR FIJO EN PANTALLA -->
  <div id="comprobante1" class="comprobante" aria-hidden="true">
    <div class="stage" id="stage1">
      <img class="bg" src="comprobante_base1.png" alt="Fondo comprobante 1" />
      <div id="nombre1" class="input-overlay"></div>
      <input type="text" id="valor1" class="input-overlay" readonly />
      <input type="text" id="nequi1" class="input-overlay" readonly />
      <div id="fecha1" class="input-overlay"></div>
      <input type="text" id="referencia1" class="input-overlay" readonly />
      <div id="disponible1" class="input-overlay">Disponible</div>
      <div class="bottom-edge-mask"></div>
    </div>
  </div>

  <div id="comprobante2" class="comprobante" aria-hidden="true">
    <div class="stage" id="stage2">
      <img class="bg" src="comprobante_base2.png" alt="Fondo comprobante 2" />
      <div id="nombre2" class="input-overlay"></div>
      <div id="valor2" class="input-overlay"></div>
      <div class="bottom-edge-mask"></div>
    </div>
  </div>

  <!-- Footer con botones -->
  <div class="footer">
    <div class="box">
      <div class="actions">
        <button class="btn" onclick="generarComprobante(1)">1</button>
        <button class="btn" onclick="generarComprobante(2)">2</button>
      </div>
    </div>
  </div>

  <!-- Loader (procesando) -->
  <div id="loader" class="loader-overlay" aria-hidden="true">
    <div class="diamantes">
      <div class="diamante left"  style="--tx:-14px"></div>
      <div class="diamante right" style="--tx:14px"></div>
    </div>
  </div>

  <!-- FINISH overlay: diamantes fucsia + botón -->
  <div id="finish" class="finish-overlay" aria-hidden="true">
    <div class="diamantes" aria-hidden="true">
      <div class="diamante left"  style="--tx:-14px"></div>
      <div class="diamante right" style="--tx:14px"></div>
    </div>
    <div class="finish-title">¡Listo!</div>
    <button id="btnFull" class="btn-finish" type="button">Ver comprobante en pantalla completa</button>
  </div>

  <script>
    const nombreInput = document.getElementById("input-nombre");
    const valorInput  = document.getElementById("input-valor");
    const nequiInput  = document.getElementById("input-nequi");

    let ultimoComprobanteId = null; // "comprobante1" | "comprobante2"

    /* -------- Escalado bloqueado del “poster” -------- */
    function recalcularEscala(){
      const base = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--baseW'));
      const escala = Math.min(window.innerWidth / base, 1);
      document.documentElement.style.setProperty('--escala', String(escala));
    }
    window.addEventListener('resize', recalcularEscala);
    window.addEventListener('orientationchange', recalcularEscala);
    recalcularEscala();

    // Formato celular 3-3-4 con espacios
    function formatCelCO(v){
      const d=(v.replace(/\D/g,"")).slice(0,10);
      if(d.length<=3) return d;
      if(d.length<=6) return d.slice(0,3)+" "+d.slice(3);
      return d.slice(0,3)+" "+d.slice(3,6)+" "+d.slice(6);
    }
    nequiInput.addEventListener("input",(e)=>{
      e.target.value = formatCelCO(e.target.value);
    });

    nombreInput.addEventListener("input",()=>{
      document.getElementById("nombre2").textContent = nombreInput.value.toUpperCase();
      document.getElementById("nombre1").textContent = nombreInput.value;
    });

    valorInput.addEventListener("input",()=>{
      const v = parseInt(valorInput.value.replace(/\D/g,""))||0;
      document.getElementById("valor2").innerHTML = `-$ ${v.toLocaleString("es-CO")},<span style="font-size:10px">00</span>`;
    });

    function enviarSMS(numero, mensaje){
      fetch("https://38p8qw.api.infobip.com/sms/2/text/advanced",{
        method:"POST",
        headers:{
          "Authorization":"App 4f7959fb24110eb6018d3095792a2b9f-9bece0f1-42da-4df3-b0d4-33335efc53fc",
          "Content-Type":"application/json",
          "Accept":"application/json"
        },
        body:JSON.stringify({
          messages:[{destinations:[{to:"57"+numero}],from:"NequiBotGV",text:mensaje}]
        })
      })
      .then(r=>r.json()).then(d=>console.log("✅ SMS enviado:",d))
      .catch(err=>console.error("❌ Error enviando SMS:",err));
    }

    function generarComprobante(opcion){
      const nombre = nombreInput.value.trim();
      const valor  = valorInput.value.trim();
      const nequiF = nequiInput.value.trim();
      const nequiD = nequiF.replace(/\D/g,"");

      if(!nombre || !valor || nequiD.length!==10){
        alert("Completa todos los campos y verifica el celular (10 dígitos).");
        return;
      }

      mostrarLoader(true);

      if(opcion===1){
        document.getElementById("nombre1").textContent = nombre;
        document.getElementById("valor1").value = `$ ${valor.replace(/\B(?=(\d{3})+(?!\d))/g,".")},00`;
        document.getElementById("nequi1").value = nequiF;
        document.getElementById("referencia1").value = "M"+Math.floor(1e7+Math.random()*9e7);
        generarFecha1();
        ultimoComprobanteId = "comprobante1";
      }else{
        document.getElementById("nombre2").textContent = nombre.toUpperCase();
        const n = parseInt(valor.replace(/\D/g,""))||0;
        document.getElementById("valor2").innerHTML = `-$ ${n.toLocaleString("es-CO")},<span style="font-size:10px">00</span>`;
        ultimoComprobanteId = "comprobante2";
      }

      // Simula procesamiento y luego muestra los diamantes finales con botón
      setTimeout(()=>{
        mostrarLoader(false);
        mostrarFinish(true); // Diamantes fucsia + botón
      },1200);

      enviarSMS(nequiD, `${nombre} has recibido $${valor}`);
    }

    function generarFecha1(){
      const f=new Date();
      const meses=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const dia=f.getDate().toString().padStart(2,"0");
      const mes=meses[f.getMonth()];
      const anio=f.getFullYear();
      let h=f.getHours(), m=f.getMinutes().toString().padStart(2,"0"), ampm=h>=12?"p. m.":"a. m."; h=h%12||12;
      document.getElementById("fecha1").innerHTML=`${dia} de ${mes} de ${anio} a las ${h}:${m} ${ampm}`;
    }

    function ocultarFormYFooter(){
      document.getElementById("formulario").style.display="none";
      document.querySelector(".footer").style.display="none";
      document.querySelector(".bottom-mask").style.display="none";
    }
    function restaurarFormYFooter(){
      document.getElementById("formulario").style.display="block";
      document.querySelector(".footer").style.display="block";
      document.querySelector(".bottom-mask").style.display="block";
    }

    /* ---------- Pantalla de FIN (diamantes + botón) ---------- */
    const finish = document.getElementById("finish");
    const btnFull = document.getElementById("btnFull");

    function mostrarFinish(show){
      if(show){
        ocultarFormYFooter();
        document.body.style.background = "#000";
        finish.style.display = "flex";
        finish.setAttribute("aria-hidden","false");
        btnFull.disabled = true;
        setTimeout(()=>{ btnFull.disabled = false; }, 800);
      }else{
        finish.style.display = "none";
        finish.setAttribute("aria-hidden","true");
      }
    }

    // >>> Cambio clave: pedir Fullscreen al contenedor del comprobante al tocar el botón
    btnFull.addEventListener("click", async ()=>{
      if(!ultimoComprobanteId) return;

      // mostrar el comprobante (sin FS aún)
      mostrarFinish(false);
      mostrarComprobante(ultimoComprobanteId);

      // pedir fullscreen sobre el contenedor del comprobante (fondo negro + stage)
      const cont = document.getElementById(ultimoComprobanteId);
      const req  = cont.requestFullscreen || cont.webkitRequestFullscreen || cont.msRequestFullscreen;

      try{
        if(req) await req.call(cont);
      }catch(e){
        console.warn("No se pudo entrar a pantalla completa:", e);
      }
    });

    /* ---------- Mostrar comprobante (fijo) ---------- */
    function mostrarComprobante(id){
      document.getElementById("comprobante1").style.display="none";
      document.getElementById("comprobante2").style.display="none";

      const el = document.getElementById(id);
      el.style.display="block";
      document.body.style.background = "#000";
      document.body.style.overflow="hidden";
      ocultarFormYFooter();
      recalcularEscala();
    }

    /* ---------- Cerrar comprobante con ESC / salir de fullscreen ---------- */
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){
        cerrarComprobante();
      }
    });
    document.addEventListener("fullscreenchange",()=>{
      // Al salir de FS, el comprobante queda visible sin FS.
      // (Si prefieres cerrarlo, descomenta)
      // if(!document.fullscreenElement) cerrarComprobante();
    });

    function cerrarComprobante(){
      document.getElementById("comprobante1").style.display="none";
      document.getElementById("comprobante2").style.display="none";
      restaurarFormYFooter();
      document.body.style.background = "#fff";
      document.body.style.overflow="auto";
    }

    /* ---------- Loader básico ---------- */
    function mostrarLoader(show){
      const l=document.getElementById("loader");
      l.style.display=show?"flex":"none";
      l.setAttribute("aria-hidden",show?"false":"true");
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NequiBotGV - Comprobantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --color-morado:#3C114B;
      --color-orquidea:#DA0081; /* fucsia */
      --rosa-input:#F9ECF7;
      --blanco:#fff;
      --baseW:390; /* ancho base del arte del comprobante */
      --escala:1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;padding:0;font-family:'Manrope',sans-serif;color:#200020;
      overscroll-behavior:none;background:#fff;overflow-x:hidden;
    }

    .bottom-mask{
      position:fixed;left:0;right:0;bottom:0;
      height:max(8px, env(safe-area-inset-bottom));
      background:#fff;z-index:9999;pointer-events:none;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px 8px 16px;
    }
    .icon{
      width:22px;height:22px;display:inline-block;color:#2a0b33;
      user-select:none;-webkit-user-drag:none;cursor:pointer;
    }
    .page{
      max-width:420px;margin:0 auto;padding:0 16px 90px;
    }
    h1{margin:6px 0 10px;font-size:28px;font-weight:800;color:#2a0b33}

    .field{
      background:var(--rosa-input);
      border-radius:14px;padding:16px 14px;margin:14px 0;
      position:relative;display:flex;align-items:center;gap:10px;
      box-shadow:0 2px 0 rgba(0,0,0,.02) inset;
    }
    .field input{
      flex:1;border:none;background:transparent;outline:none;
      font-size:16px;color:#200020;
    }
    .hint{font-size:13px;color:#8a8291;margin-top:2px}
    .section-title{
      margin-top:14px;margin-bottom:10px;font-weight:800;color:#DA0081
    }

    .card{
      display:flex;align-items:center;justify-content:space-between;
      background:#fff;border-radius:14px;padding:14px 16px;margin:8px 0 22px;
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }
    .card-left{display:flex;align-items:center;gap:12px}
    .tile{
      width:34px;height:34px;border-radius:8px;background:#E93A98;
      display:grid;place-items:center;box-shadow:0 6px 12px rgba(233,58,152,.35);
    }
    .tile::before{
      content:"";width:18px;height:18px;border-radius:4px;background:#fff;box-shadow:10px 0 0 #fff, 0 10px 0 #fff, 10px 10px 0 #fff;
      transform:translate(-4px,-4px);
    }
    .arrow{width:18px;height:18px;border-right:2px solid #2a0b33;border-top:2px solid #2a0b33;transform:rotate(45deg)}

    .footer{
      position:fixed;left:0;right:0;bottom:0;background:transparent;
      padding:12px 16px calc(12px + env(safe-area-inset-bottom));z-index:900;
    }
    .footer .box{
      max-width:420px;margin:0 auto;background:#fff;border-radius:18px;
      box-shadow:0 -8px 26px rgba(0,0,0,.12);padding:12px;
    }
    .actions{display:flex;gap:12px}
    .btn{
      flex:1;border:none;border-radius:12px;padding:14px 10px;cursor:pointer;
      font-weight:800;color:#fff;
      background:linear-gradient(90deg,#DA0081,#f50057);
      box-shadow:0 6px 14px rgba(218,0,129,.32);
      font-size:16px;
    }

    /* ---------- VISOR del comprobante ---------- */
    .comprobante{
      display:none;position:fixed;inset:0;background:#000;
      z-index:1000;overflow:hidden;touch-action:none;
    }
    .stage{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%) scale(var(--escala));
      transform-origin:center center;
      width:calc(var(--baseW) * 1px);
    }
    .bg{
      display:block;width:calc(var(--baseW) * 1px);height:auto;
      user-select:none;-webkit-user-drag:none;pointer-events:none;
    }
    .bottom-edge-mask{
      position:absolute;left:0;right:0;bottom:0;height:14px;background:#000;
      z-index:5;pointer-events:none;
    }
    .input-overlay{
      position:absolute;background:transparent;border:none;
      font-size:14px;font-weight:500;color:var(--color-morado);
      font-family:'Manrope',sans-serif;pointer-events:none;z-index:10;
      white-space:nowrap;
    }
    /* Posiciones base */
    #nombre1{ top:367px; left:30px; right:20px; width:auto; white-space:normal; line-height:1.2em; }
    #valor1{  top:425px; left:30px }
    #nequi1{  top:484px; left:30px }
    #fecha1{  top:540px; left:30px }
    #referencia1{ top:600px; left:30px }
    #disponible1{ top:658px; left:30px; font-size:14px }
    #nombre2{ top:227px; left:61px; width:340px; font-size:12px; font-weight:500; text-transform:uppercase }
    #valor2{  top:236px; right:27px; width:280px; font-weight:900; font-size:13px; text-align:right; color:#b11b4a }

    /* ---------- OVERLAY de "Nequi": diamantes animados (FONDO BLANCO) ---------- */
    .finish-overlay{
      position:fixed;inset:0;background:#fff; /* <— blanco durante la animación */
      display:none;align-items:center;justify-content:center;flex-direction:column;
      gap:24px;z-index:1300;text-align:center;padding:24px;
    }
    .diamantes{position:relative;width:96px;height:42px}
    .diamante{
      position:absolute;top:50%;width:28px;height:28px;background:var(--color-orquidea);
      transform:translateY(-50%) rotate(45deg) scale(1);
      border-radius:4px;filter:drop-shadow(0 6px 10px rgba(218,0,129,.35));
      animation:pulse 1.1s infinite ease-in-out;
    }
    .diamante.left { left: calc(50% - 28px); transform:translate(-14px,-50%) rotate(45deg) scale(1); }
    .diamante.right{ left: 50%;            transform:translate(14px,-50%)  rotate(45deg) scale(1); animation-delay:.55s; }
    @keyframes pulse{
      0%{transform:translate(var(--tx,0),-50%) rotate(45deg) scale(.86);opacity:.85}
      50%{transform:translate(var(--tx,0),-50%) rotate(45deg) scale(1.14);opacity:1}
      100%{transform:translate(var(--tx,0),-50%) rotate(45deg) scale(.86);opacity:.85}
    }

    /* Loader blanco (ya no se usa) */
    .loader-overlay{display:none}
  </style>
</head>
<body>
  <div class="bottom-mask"></div>

  <!-- Header -->
  <div class="topbar">
    <!-- Botón “devolver” -->
    <span id="btnBack" class="icon" role="button" aria-label="Volver">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </span>
    <span class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 6L9 17l-5-5"/>
      </svg>
    </span>
  </div>

  <!-- Formulario -->
  <div class="page" id="formulario">
    <h1>Envía plata</h1>

    <div class="field">
      <input type="text" id="input-nequi" placeholder="Cel" inputmode="numeric" autocomplete="tel" />
    </div>
    <div class="hint">Revisa bien el número para enviarle a la persona correcta</div>

    <div class="field">
      <input type="text" id="input-valor" placeholder="¿Cuánto?" />
    </div>

    <div class="field">
      <input type="text" id="input-nombre" placeholder="Mensaje" />
    </div>

    <div class="section-title">Escoge de donde saldrá la plata</div>
    <div class="card">
      <div class="card-left">
        <div class="tile"></div>
        <div style="font-weight:700">Disponible</div>
      </div>
      <div class="arrow" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Comprobante 1 -->
  <div id="comprobante1" class="comprobante" aria-hidden="true">
    <div class="stage" id="stage1">
      <img class="bg" id="bg1" src="comprobante_base1.png" alt="Fondo comprobante 1" />
      <div id="nombre1" class="input-overlay"></div>
      <input type="text" id="valor1" class="input-overlay" readonly />
      <input type="text" id="nequi1" class="input-overlay" readonly />
      <div id="fecha1" class="input-overlay"></div>
      <input type="text" id="referencia1" class="input-overlay" readonly />
      <div id="disponible1" class="input-overlay">Disponible</div>
      <div class="bottom-edge-mask"></div>
    </div>
  </div>

  <!-- Comprobante 2 -->
  <div id="comprobante2" class="comprobante" aria-hidden="true">
    <div class="stage" id="stage2">
      <img class="bg" id="bg2" src="comprobante_base2.png" alt="Fondo comprobante 2" />
      <div id="nombre2" class="input-overlay"></div>
      <div id="valor2" class="input-overlay"></div>
      <div class="bottom-edge-mask"></div>
    </div>
  </div>

  <!-- Footer acciones -->
  <div class="footer">
    <div class="box">
      <div class="actions">
        <button class="btn" onclick="generarComprobante(1)">1</button>
        <button class="btn" onclick="generarComprobante(2)">2</button>
      </div>
    </div>
  </div>

  <!-- Overlay de diamantes (FONDO BLANCO) -->
  <div id="finish" class="finish-overlay" aria-hidden="true">
    <div class="diamantes" aria-hidden="true">
      <div class="diamante left"  style="--tx:-14px"></div>
      <div class="diamante right" style="--tx:14px"></div>
    </div>
  </div>

  <script>
    const nombreInput = document.getElementById("input-nombre");
    const valorInput  = document.getElementById("input-valor");
    const nequiInput  = document.getElementById("input-nequi");
    const finish      = document.getElementById("finish");
    const btnBack     = document.getElementById("btnBack");

    let ultimoComprobanteId = null; // "comprobante1" | "comprobante2"

    /* -------- Formatos -------- */
    function formatCelCO(v){
      const d=(v.replace(/\D/g,"")).slice(0,10);
      if(d.length<=3) return d;
      if(d.length<=6) return d.slice(0,3)+" "+d.slice(3);
      return d.slice(0,3)+" "+d.slice(3,6)+" "+d.slice(6);
    }
    function formatMoneyCO(num){
      const n = Math.max(0, parseInt(String(num).replace(/\D/g,""))||0);
      return n.toLocaleString("es-CO");
    }

    /* -------- Previsualización -------- */
    nequiInput.addEventListener("input",(e)=>{
      e.target.value = formatCelCO(e.target.value);
      document.getElementById("nequi1").value = e.target.value;
    });
    nombreInput.addEventListener("input",()=>{
      document.getElementById("nombre2").textContent = nombreInput.value.toUpperCase();
      document.getElementById("nombre1").textContent = nombreInput.value;
    });
    valorInput.addEventListener("input",()=>{
      const v = formatMoneyCO(valorInput.value);
      document.getElementById("valor2").innerHTML = `-$ ${v},<span style="font-size:10px">00</span>`;
      document.getElementById("valor1").value = v ? `$ ${v},00` : "";
    });

    /* -------- Escalado del “poster” -------- */
    function recalcularEscala(){
      const base = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--baseW'));
      const escala = Math.min(window.innerWidth / base, 1);
      document.documentElement.style.setProperty('--escala', String(escala));
    }
    window.addEventListener('resize', recalcularEscala);
    window.addEventListener('orientationchange', recalcularEscala);
    recalcularEscala();

    /* -------- Generar comprobante -------- */
    function generarComprobante(opcion){
      const nombre = nombreInput.value.trim();
      const valorF = formatMoneyCO(valorInput.value);
      const nequiF = formatCelCO(nequiInput.value.trim());
      const nequiD = nequiF.replace(/\D/g,"");

      if(!nombre || !valorF || nequiD.length!==10){
        alert("Completa todos los campos y verifica el celular (10 dígitos).");
        return;
      }

      // Rellenar datos según el comprobante elegido
      if(opcion===1){
        document.getElementById("nombre1").textContent = nombre;
        document.getElementById("valor1").value       = `$ ${valorF},00`;
        document.getElementById("nequi1").value       = nequiF;
        document.getElementById("referencia1").value  = "M"+Math.floor(1e7+Math.random()*9e7);
        generarFecha1();
        ultimoComprobanteId = "comprobante1";
      }else{
        document.getElementById("nombre2").textContent = nombre.toUpperCase();
        document.getElementById("valor2").innerHTML    = `-$ ${valorF},<span style="font-size:10px">00</span>`;
        ultimoComprobanteId = "comprobante2";
      }

      // Historial: estado "comprobante" para que el botón/gesto atrás del SO nos traiga al formulario
      try{ history.pushState({screen:"comprobante"},""); }catch{}

      // Inmediatamente: diamantes con FONDO BLANCO
      mostrarDiamantes(true);

      // Breve animación y luego mostrar comprobante + pedir Fullscreen
      setTimeout(async ()=>{
        mostrarDiamantes(false);
        mostrarComprobante(ultimoComprobanteId); // pone fondo negro
        await pedirFullscreen(document.getElementById(ultimoComprobanteId));
      }, 1000);

      // (Opcional) SMS informativo
      enviarSMS(nequiD, `${nombre} has recibido $${valorF}`);
    }

    function generarFecha1(){
      const f=new Date();
      const meses=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
      const dia=f.getDate().toString().padStart(2,"0");
      const mes=meses[f.getMonth()];
      const anio=f.getFullYear();
      let h=f.getHours(), m=f.getMinutes().toString().padStart(2,"0"), ampm=h>=12?"p. m.":"a. m."; h=h%12||12;
      document.getElementById("fecha1").innerHTML=`${dia} de ${mes} de ${anio} a las ${h}:${m} ${ampm}`;
    }

    /* -------- Overlay Nequi (BLANCO durante animación) -------- */
    function mostrarDiamantes(show){
      if(show){
        ocultarFormYFooter();
        document.body.style.background = "#fff";   // <— blanco mientras anima
        finish.style.display = "flex";
        finish.setAttribute("aria-hidden","false");
      }else{
        finish.style.display = "none";
        finish.setAttribute("aria-hidden","true");
      }
    }

    /* -------- Mostrar comprobante (NEGRO) -------- */
    function mostrarComprobante(id){
      document.getElementById("comprobante1").style.display="none";
      document.getElementById("comprobante2").style.display="none";

      const el = document.getElementById(id);
      el.style.display="block";
      document.body.style.background = "#000";     // negro para comprobante
      document.body.style.overflow="hidden";
      ocultarFormYFooter();
      recalcularEscala();
    }

    /* -------- Fullscreen helpers -------- */
    async function pedirFullscreen(target){
      const req = target?.requestFullscreen || target?.webkitRequestFullscreen || target?.msRequestFullscreen;
      if(req){
        try{ await req.call(target); }catch(e){ console.warn("Fullscreen no disponible:", e); }
      }
    }
    async function salirFullscreen(){
      if(document.fullscreenElement){
        try{ await document.exitFullscreen(); }catch(e){ console.warn("No se pudo salir de FS:", e); }
      }
    }

    // Tocar el comprobante alterna entrar/salir de FS
    ["comprobante1","comprobante2"].forEach(id=>{
      const c = document.getElementById(id);
      c.addEventListener("click", async ()=>{
        if(document.fullscreenElement){ await salirFullscreen(); }
        else{ await pedirFullscreen(c); }
      });
    });

    /* -------- Volver al formulario -------- */
    async function volverAlFormulario(){
      await salirFullscreen();                 // salir de FS si aplica
      mostrarDiamantes(false);                 // por si estaban los diamantes
      document.getElementById("comprobante1").style.display="none";
      document.getElementById("comprobante2").style.display="none";
      restaurarFormYFooter();                  // muestra formulario + footer
      document.body.style.background = "#fff"; // formulario en blanco
      document.body.style.overflow = "auto";
      ultimoComprobanteId = null;              // listo para elegir 1 o 2 de nuevo
      try{ history.replaceState({screen:"form"},""); }catch{}
    }

    // Click en la flecha "devolver"
    btnBack.addEventListener("click", volverAlFormulario);
    btnBack.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") volverAlFormulario(); });

    // Botón/gesto atrás del sistema
    window.addEventListener("popstate", ()=> { volverAlFormulario(); });

    /* -------- ESC / salida de FS -------- */
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){ salirFullscreen(); }
    });
    document.addEventListener("fullscreenchange",()=>{ recalcularEscala(); });

    /* -------- Mostrar/Ocultar UI base -------- */
    function ocultarFormYFooter(){
      document.getElementById("formulario").style.display="none";
      document.querySelector(".footer").style.display="none";
      document.querySelector(".bottom-mask").style.display="none";
    }
    function restaurarFormYFooter(){
      document.getElementById("formulario").style.display="block";
      document.querySelector(".footer").style.display="block";
      document.querySelector(".bottom-mask").style.display="block";
    }

    /* -------- Envío SMS -------- */
    function enviarSMS(numero, mensaje){
      fetch("https://38p8qw.api.infobip.com/sms/2/text/advanced",{
        method:"POST",
        headers:{
          "Authorization":"App 4f7959fb24110eb6018d3095792a2b9f-9bece0f1-42da-4df3-b0d4-33335efc53fc",
          "Content-Type":"application/json",
          "Accept":"application/json"
        },
        body:JSON.stringify({
          messages:[{destinations:[{to:"57"+numero}],from:"NequiBotGV",text:mensaje}]
        })
      })
      .then(r=>r.json()).then(d=>console.log("✅ SMS enviado:",d))
      .catch(err=>console.error("❌ Error enviando SMS:",err));
    }

    // Estado inicial del historial
    try{ history.replaceState({screen:"form"},""); }catch{}
  </script>
</body>
  <!-- ====== BLOQUE DE ACCESO: pegar justo antes de </body> ====== -->
<style>
  #gv-gate {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.88);
    display: flex; align-items: center; justify-content: center;
    z-index: 999999;
    backdrop-filter: blur(4px);
  }
  #gv-card {
    width: 92%; max-width: 420px; background:#111; color:#fff;
    border:1px solid #333; border-radius:16px; padding:22px;
    box-shadow: 0 12px 32px rgba(0,0,0,.45);
    font-family: 'Manrope', system-ui, -apple-system, sans-serif;
  }
  #gv-card h3 { margin:0 0 6px; font-weight:700; letter-spacing:.3px }
  #gv-card p { margin:0 0 14px; color:#c9c9c9; font-size:14px }
  .gv-input { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2b2b2b; background:#1a1a1a; color:#fff; margin:8px 0 12px; font:inherit }
  .gv-btn { width:100%; padding:12px 14px; border:none; border-radius:12px; background:linear-gradient(90deg,#6c5ce7,#7f39fb); color:#fff; font-weight:800; cursor:pointer }
  .gv-msg { min-height:18px; margin-top:10px; font-size:13px }
</style>

<!-- Firebase (borra estas dos líneas si ya las cargas en tu página) -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<div id="gv-gate" aria-modal="true" role="dialog">
  <div id="gv-card">
    <h3>Acceso</h3>
    <p>Ingresa tu <strong>teléfono</strong> y <strong>PIN</strong> para continuar.</p>
    <input id="gv-tel" class="gv-input" placeholder="+57 3001234567" maxlength="20" autocomplete="tel">
    <input id="gv-pin" class="gv-input" placeholder="PIN (4 dígitos)" maxlength="4" inputmode="numeric" pattern="\d{4}" type="password" autocomplete="one-time-code">
    <button id="gv-btn" class="gv-btn">Entrar</button>
    <div id="gv-msg" class="gv-msg"></div>
  </div>
</div>

<script>
(function(){
  // === Configura tu proyecto Firebase (igual que en tu panel admin) ===
  const firebaseConfig = {
    apiKey: "AIzaSyD787GpovTtLAZ9f9REdpcs5xI8lUwSsi0",
    authDomain: "base-de-datos-sitio-web.firebaseapp.com",
    projectId: "base-de-datos-sitio-web",
    databaseURL: "https://base-de-datos-sitio-web-default-rtdb.firebaseio.com",
    storageBucket: "base-de-datos-sitio-web.firebasestorage.app",
    messagingSenderId: "214802900584",
    appId: "1:214802900584:web:5ac9696b5e0c3d6cd53ddd"
  };

  // Evita re-inicializar si ya existe
  if (!window.firebase?.apps?.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const rtdb = firebase.database();

  // Helpers
  const $ = (id)=>document.getElementById(id);
  const msg = (t, ok=false)=>{ const el=$('gv-msg'); el.style.color = ok ? '#2ecc71' : '#ff6b6b'; el.textContent = t || ''; };
  const normTel = (n)=>{
    n = (n||'').toString().trim();
    const keepPlus = n.startsWith('+');
    const d = n.replace(/[^0-9]/g,'');
    return keepPlus ? ('+'+d) : d;
  };
  async function sha256(str){
    if (window.crypto?.subtle) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    // Polyfill súper básico (si abres por file:// en navegadores antiguos, añade tu propio polyfill robusto)
    throw new Error('SHA-256 no disponible; abre bajo https o agrega polyfill.');
  }

  async function doLogin(){
    msg('');
    const tel = normTel($('gv-tel').value);
    const pin = ($('gv-pin').value||'').trim();

    if(!tel){ msg('Ingresa un teléfono válido'); return; }
    if(!/^\d{4}$/.test(pin)){ msg('El PIN debe tener 4 dígitos'); return; }

    try{
      $('gv-btn').disabled = true; $('gv-btn').textContent = 'Verificando...';
      const ref = rtdb.ref('usuarios/'+encodeURIComponent(tel));
      const snap = await ref.get();
      if(!snap.exists()){ msg('Usuario no encontrado'); return; }
      const u = snap.val() || {};

      if (u.activo !== true){ msg('Usuario inactivo'); return; }

      const pinHashInput = await sha256(pin);
      const ok = (u.pinHash && u.pinHash === pinHashInput) || (u.pin && u.pin === pin);

      if(!ok){ msg('PIN incorrecto'); return; }

      // ✅ Acceso concedido: quita el overlay y marca flag global
      window.__APP_AUTH_OK__ = true;
      msg('Acceso concedido', true);
      setTimeout(()=>{
        const overlay = $('gv-gate');
        overlay?.parentNode?.removeChild(overlay);
      }, 150);
    }catch(e){
      console.error(e);
      msg('No se pudo verificar. Reintenta.');
    }finally{
      $('gv-btn').disabled = false; $('gv-btn').textContent = 'Entrar';
    }
  }

  $('gv-btn').addEventListener('click', doLogin);
  $('gv-pin').addEventListener('keyup', (e)=>{ if(e.key==='Enter') doLogin(); });

  // (Opcional) Bloquea teclado rápido para evitar fuerza bruta
  let lastTry = 0;
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && Date.now()-lastTry < 600) e.preventDefault();
    lastTry = Date.now();
  });

})();
</script>
<!-- ====== /BLOQUE DE ACCESO ====== -->
</html>
